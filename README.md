# ğŸ¥ Loop AI: Omnichannel Voice Agent for Hospital Networks

![Python](https://img.shields.io/badge/Python-3.10+-blue.svg)
![FastAPI](https://img.shields.io/badge/FastAPI-0.100+-00a67e.svg)
![LangGraph](https://img.shields.io/badge/LangGraph-State_Machine-orange.svg)
![Twilio](https://img.shields.io/badge/Twilio-Telephony-red.svg)

An enterprise-grade AI voice agent built to navigate a massive hospital network database. This project was developed as a technical assignment to demonstrate advanced LLM orchestration, stateful conversational memory, and omnichannel API integration (Web UI + Telephony).

---

## ğŸš€ Architectural Highlights

Instead of forcing a massive CSV file into an LLM's context window (which is slow, expensive, and prone to hallucinations), this agent uses a **Text-to-SQL Graph Architecture**. 

1. **Deterministic Data Retrieval:** The AI translates natural language into dynamic SQLite queries, querying the database directly for millimeter-perfect accuracy and single-digit millisecond latency.
2. **Data Prefetching & Memory:** The SQL agent utilizes a `SELECT *` prefetching layer. This holds rich data (like addresses and cities) in a transient conversational state, allowing the agent to answer follow-up questions (e.g., *"What's the address of the second one?"*) without crashing the database or requiring redundant API calls.
3. **Omnichannel Design:** A unified FastAPI backend processes audio streams from both a custom WebRTC browser frontend and live Twilio phone calls simultaneously.
4. **Self-Healing SQL Execution:** A reflection node catches and automatically repairs bad SQL syntax generated by the LLM before it reaches the user.

---

## âœ¨ Core Features

* **Extreme Fuzzy Matching:** Custom SQL rules handle typos, multi-word spacing, and regional aliases (e.g., smoothly resolving "Bangalore" to "Bengaluru").
* **Out-of-Scope Rejection:** A strict Intent Router detects non-healthcare queries, reads a mandatory polite rejection phrase, and triggers a physical `<Hangup>` over the Twilio network.
* **Smart Pagination:** Memory states track offsets, allowing users to ask for "5 more hospitals" seamlessly.
* **Concise Voice Synthesis:** The agent intelligently strips away Markdown formatting and parses data into natural, human-sounding TTS (Text-to-Speech) without reading unnecessary database jargon.

---

## ğŸ› ï¸ Technology Stack

* **Backend:** Python, FastAPI, Uvicorn
* **AI & Orchestration:** LangGraph (State Machines), LangChain, Google Gemini 2.5 Flash
* **Voice Processing:** Twilio Voice API (TwiML), Google SpeechRecognition, gTTS, Pydub
* **Data Processing:** SQLite, Pandas (for automated CSV-to-DB ingestion)
* **Frontend:** Vanilla JS, HTML5 MediaRecorder API

---

## ğŸ“‚ Project Structure

```text
â”œâ”€â”€ app/
â”‚   â”œâ”€â”€ main.py       # FastAPI application, routing, and Twilio/Web endpoints
â”‚   â”œâ”€â”€ graph.py      # LangGraph state machine, intent router, and LLM nodes
â”‚   â””â”€â”€ tools.py      # Automated CSV-to-SQLite database initialization
â”œâ”€â”€ data/
â”‚   â”œâ”€â”€ hospitals.csv # Raw hospital dataset (provided)
â”‚   â””â”€â”€ hospitals.db  # Auto-generated SQLite database
â”œâ”€â”€ frontend/
â”‚   â”œâ”€â”€ index.html    # Minimalist Web UI
â”‚   â””â”€â”€ app.js        # MediaRecorder audio streaming logic
â”œâ”€â”€ .env.example      # Environment variables template
â”œâ”€â”€ requirements.txt  # Python dependencies
â””â”€â”€ README.md         # Project documentation
```
---

## âš™ï¸ Local Setup & Installation

### 1. Clone the repository
```bash
git clone [https://github.com/yourusername/Loop-AI-Voice-Agent.git](https://github.com/yourusername/Loop-AI-Voice-Agent.git)
cd Loop-AI-Voice-Agent
```
---

## Install dependencies

Ensure you have ffmpeg installed on your system for pydub audio processing, then run:

```Bash
pip install -r requirements.txt
```
---

## Environment Variables

Create a .env file in the root directory and add your Google Gemini API key:
```Bash
Code snippet
GEMINI_API_KEY=your_google_gemini_api_key_here
```
---

## Run the Backend Server

```Bash
uvicorn app.main:app --reload
Note: On the very first startup, tools.py will automatically convert the raw CSV into a highly optimized SQLite database (hospitals.db).
```
---
## Test the Web Interface

Simply open frontend/index.html in any modern web browser, allow microphone permissions, and start speaking!

---

## Connect Twilio (Optional Telephony Setup)

Expose your local server to the internet using ngrok:

```Bash
ngrok http 8000
Copy your ngrok HTTPS URL.
```
In your Twilio Console, configure your active phone number's "A Call Comes In" webhook to: https://<your-ngrok-url>.ngrok-free.app/voice (Method: HTTP POST).

Call your Twilio number from your cell phone!
---
